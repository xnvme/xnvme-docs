<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" /><meta name="generator" content="Docutils 0.17: http://docutils.sourceforge.net/" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Linux Dev. Environment &mdash; xNVMe 0.7.2 documentation</title><link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
    <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
      <link rel="stylesheet" href="../../_static/theme_overrides.css" type="text/css" />
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  <script id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
    <script src="../../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
    <link rel="next" title="Dynamically loading xNVMe" href="../dynamic_loading/index.html" />
    <link rel="prev" title="Flexible Data Placement" href="../fdp/index.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../../index.html" class="icon icon-home">
            xNVMe
          </a>
              <div class="version">
                0.7.2
              </div>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../../getting_started/index.html">Getting Started</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../tools/index.html">Tools</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../capis/index.html">C API</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../examples/index.html">C API: Examples</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="../index.html">Tutorials</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../fdp/index.html">Flexible Data Placement</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">Linux Dev. Environment</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#physical-machine">Physical Machine</a></li>
<li class="toctree-l3"><a class="reference internal" href="#operating-system">Operating System</a></li>
<li class="toctree-l3"><a class="reference internal" href="#homedir">Homedir</a></li>
<li class="toctree-l3"><a class="reference internal" href="#screen-http-server">Screen + http.server</a></li>
<li class="toctree-l3"><a class="reference internal" href="#cijoe">CIJOE</a></li>
<li class="toctree-l3"><a class="reference internal" href="#linux-kernel">Linux Kernel</a></li>
<li class="toctree-l3"><a class="reference internal" href="#qemu">Qemu</a></li>
<li class="toctree-l3"><a class="reference internal" href="#xnvme">xNVMe</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#clone-build-and-install">clone, build, and install</a></li>
<li class="toctree-l4"><a class="reference internal" href="#artifacts">Artifacts</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#reproduce-github-actions-locally">Reproduce GitHUB Actions locally</a></li>
<li class="toctree-l3"><a class="reference internal" href="#running-pytest-from-the-repository">Running pytest from the repository</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#provision-a-qemu-guest">Provision a qemu-guest</a></li>
<li class="toctree-l4"><a class="reference internal" href="#create-boot-images">Create boot-images</a></li>
</ul>
</li>
<li class="toctree-l3"><a class="reference internal" href="#remote-dev">Remote dev</a></li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="../dynamic_loading/index.html">Dynamically loading xNVMe</a></li>
<li class="toctree-l2"><a class="reference internal" href="../fabrics/index.html">NVMe-over-Fabrics</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../../python/index.html">Python</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../contributing/index.html">Contributing</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../ci/index.html">CI</a></li>
</ul>

        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">xNVMe</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../../index.html" class="icon icon-home" aria-label="Home"></a></li>
          <li class="breadcrumb-item"><a href="../index.html">Tutorials</a></li>
      <li class="breadcrumb-item active">Linux Dev. Environment</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../../_sources/tutorial/devs/index.rst.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="linux-dev-environment">
<span id="sec-tutorials-devs-linux"></span><h1>Linux Dev. Environment<a class="headerlink" href="#linux-dev-environment" title="Permalink to this headline">¶</a></h1>
<p>This shows the manual steps of setting up a physical machine for <strong>xNVMe</strong> test
and development. This includes using devices attached to the machine, as well
as using the physical machine to setup virtual machines with advanced
NVMe-device emulation.</p>
<p>Advanced NVMe device emulation covers command-set enchancements such as
Flexible Data-Placement (FDP), Zoned Namespaces (ZNS), and Key-Value SSDs (KV).</p>
<p>The documentation is provided as a means to setup development environment with
minimal fuss and maximum foss :)</p>
<ul class="simple">
<li><p>Custom Linux kernel</p>
<ul>
<li><p>Built from source</p></li>
<li><p>Installed via <code class="docutils literal notranslate"><span class="pre">.deb</span></code></p></li>
</ul>
</li>
<li><p>Custom Qemu</p>
<ul>
<li><p>Built from source</p></li>
<li><p>Latest NVMe emulation features</p></li>
</ul>
</li>
<li><p>xNVMe</p>
<ul>
<li><p>Built from source</p></li>
<li><p>Testing package</p></li>
</ul>
</li>
</ul>
<section id="physical-machine">
<span id="sec-tutorials-devs-linux-pm"></span><h2>Physical Machine<a class="headerlink" href="#physical-machine" title="Permalink to this headline">¶</a></h2>
<p>It is assumes that you have a physisical machine with NVMe storage available,
and that you can utilize it destructively. By desctructively, what is meant, is
that any data can and will be lost.</p>
<p>Most machines will do for common development and testing, throughout an machine
with the following traits are used:</p>
<ul class="simple">
<li><p>An x86 64-bit CPU</p></li>
<li><p>At least 8GB of memory</p></li>
<li><p>A SATA SSD, 100GB will suffice, used for the</p>
<ul>
<li><p>Operating system</p></li>
<li><p>User data (<code class="docutils literal notranslate"><span class="pre">$HOME</span></code>), repositories, workdirs, etc.</p></li>
</ul>
</li>
<li><p>One or more NVMe SSDs</p>
<ul>
<li><p>Utilized for testing</p></li>
</ul>
</li>
</ul>
<p>This physical machine will be referred to as <code class="docutils literal notranslate"><span class="pre">box01</span></code>.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Since, the devices utilized for testing a primarily NVMe devices, then it is
convenient to have the operating system and user-data installed on a
separate non-NVMe device, quite simply since SATA pops up as <code class="docutils literal notranslate"><span class="pre">/dev/sd*</span></code>
and NVMe as <code class="docutils literal notranslate"><span class="pre">/dev/nvme*</span></code> / <code class="docutils literal notranslate"><span class="pre">/dev/ng*</span></code>. It avoids one accidentally wiping
the OS device when the devices are entirely separate.</p>
</div>
</section>
<section id="operating-system">
<span id="sec-tutorials-devs-linux-os"></span><h2>Operating System<a class="headerlink" href="#operating-system" title="Permalink to this headline">¶</a></h2>
<p>Here, the latest <strong>stable</strong> Debian Linux, currently <strong>bookworm</strong> is used
throughout.</p>
<ul class="simple">
<li><p>Install it</p>
<ul>
<li><p>Un-select desktop environment</p></li>
<li><p>Select OpenSSH</p></li>
</ul>
</li>
<li><p>Add user <code class="docutils literal notranslate"><span class="pre">odus</span></code> with password as you see fit</p></li>
<li><p>Partition using the entire device</p></li>
<li><p>Setup networking</p></li>
</ul>
<p>And make sure it is accessible from your “main” development machine:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ssh-copy-id<span class="w"> </span>odus@box01
</pre></div>
</div>
<p>Log into the machine:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>ssh<span class="w"> </span>odus@box01
</pre></div>
</div>
<p>And then install a couple of things:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Switch to root</span>
su<span class="w"> </span>-
apt-get<span class="w"> </span>-qy<span class="w"> </span>update<span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span>apt-get<span class="w"> </span>-qy<span class="w"> </span>install<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>git<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>htop<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>screen<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>sudo<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>vim

<span class="c1"># Add odus to sudoers (required to do various things as non-root)</span>
usermod<span class="w"> </span>-aG<span class="w"> </span>sudo<span class="w"> </span>odus

<span class="c1"># Add odus to kvm (required to run qemu as non-root)</span>
usermod<span class="w"> </span>-aG<span class="w"> </span>kvm<span class="w"> </span>odus

<span class="c1"># switch back out of root</span>
<span class="nb">exit</span>

<span class="c1"># log out of odus</span>
<span class="nb">exit</span>
</pre></div>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Log out and back in again, to refresh credentials</p>
</div>
<p>Additionally, in order to prepare the system for user-space NVMe drivers, then
vfio/iommu should be enabled along with a couple of user-limit tweaks.</p>
<p>Have a look at the <a class="reference internal" href="../../getting_started/index.html#sec-gs-system-config-userspace-config"><span class="std std-ref">Config</span></a> section for the
details on this.</p>
</section>
<section id="homedir">
<span id="sec-tutorials-devs-linux-homedir"></span><h2>Homedir<a class="headerlink" href="#homedir" title="Permalink to this headline">¶</a></h2>
<p>Regardless of whether you are using the <strong>box</strong> directly as <code class="docutils literal notranslate"><span class="pre">root</span></code>, or using the
<code class="docutils literal notranslate"><span class="pre">odus</span></code> user, then setup the <code class="docutils literal notranslate"><span class="pre">$HOME</span></code> directory like so:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>mkdir<span class="w"> </span><span class="nv">$HOME</span>/<span class="o">{</span>artifacts,git,workdirs,guests,images<span class="o">}</span>
</pre></div>
</div>
<p>The directories are used for the following:</p>
<dl class="simple">
<dt><strong>git</strong></dt><dd><p>A place to store source-repositories, usually these are git repositories for
projects like: xnvme, fio, spdk, linux, and qemu.</p>
</dd>
<dt><strong>workdirs</strong></dt><dd><p>A place for auxilary files, when executing <strong>cijoe</strong> workflows, or doing
misc. experiments and exploration.</p>
</dd>
<dt><strong>artifacts</strong></dt><dd><p>A place to store intermediate artifacts during development. Such as adhoc
Linux kernel <code class="docutils literal notranslate"><span class="pre">.deb</span></code> packages, source-archives etc.</p>
</dd>
<dt><strong>guests</strong></dt><dd><p>A place where boot-images, pid-files, cloud-seeds and other files related to
qemu guests live.</p>
</dd>
<dt><strong>images</strong></dt><dd><p>A place to store VM “boot-images”, such as cloud-init enabled images.</p>
</dd>
</dl>
</section>
<section id="screen-http-server">
<span id="sec-tutorials-devs-linux-screen"></span><h2>Screen + http.server<a class="headerlink" href="#screen-http-server" title="Permalink to this headline">¶</a></h2>
<p>Regardless of whether your <strong>devbox</strong> is physical/virtual/local/remote or some
combination thereof. Then having access to misc. files, and specifically, to
things like <strong>cijoe</strong> output / reports. Is very convenient.</p>
<p>With minimal fuss, then this is achievable with a combinaion of <code class="docutils literal notranslate"><span class="pre">screen</span></code> and
Python:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span><span class="w"> </span>~/workdirs
screen<span class="w"> </span>-d<span class="w"> </span>-m<span class="w"> </span>python3<span class="w"> </span>-m<span class="w"> </span>http.server
</pre></div>
</div>
<p>The above starts a webserver, serving the content of the <code class="docutils literal notranslate"><span class="pre">cwd</span></code> where
<code class="docutils literal notranslate"><span class="pre">python3</span></code> is executed and served up over <code class="docutils literal notranslate"><span class="pre">tcp/http</span></code> on port <strong>8000</strong>.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">screen</span> <span class="pre">-d</span> <span class="pre">-m</span></code> part, creates a screen-session and detaches from it. Thus,
it continues executing even if you disconnect.</p>
<p>You can see the running screen-sessions with:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>screen<span class="w"> </span>-list
</pre></div>
</div>
<p>And attach to them using their <code class="docutils literal notranslate"><span class="pre">&lt;name&gt;</span></code>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>screen<span class="w"> </span>-r<span class="w"> </span>&lt;name&gt;
</pre></div>
</div>
</section>
<section id="cijoe">
<span id="sec-tutorials-devs-linux-cijoe"></span><h2>CIJOE<a class="headerlink" href="#cijoe" title="Permalink to this headline">¶</a></h2>
<p>Setup <code class="docutils literal notranslate"><span class="pre">python3</span></code> and <code class="docutils literal notranslate"><span class="pre">pipx</span></code>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo<span class="w"> </span>apt-get<span class="w"> </span>-qy<span class="w"> </span>install<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>pipx<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>python3-pip<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>python3-venv
sudo<span class="w"> </span>apt-get<span class="w"> </span>remove<span class="w"> </span>-qy<span class="w"> </span>python3-pytest
sudo<span class="w"> </span>pipx<span class="w"> </span>ensurepath
</pre></div>
</div>
<p>Then install <strong>cijoe</strong> in a <code class="docutils literal notranslate"><span class="pre">pipx</span></code> virtual environment:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>pipx<span class="w"> </span>install<span class="w"> </span>cijoe<span class="w"> </span>--include-deps
pipx<span class="w"> </span>inject<span class="w"> </span>cijoe<span class="w"> </span>cijoe-pkg-linux
pipx<span class="w"> </span>inject<span class="w"> </span>cijoe<span class="w"> </span>cijoe-pkg-qemu
pipx<span class="w"> </span>inject<span class="w"> </span>cijoe<span class="w"> </span>cijoe-pkg-fio
</pre></div>
</div>
<p>Then logout and back in to reload the environment, the addition of <code class="docutils literal notranslate"><span class="pre">pipx</span></code> and
the <code class="docutils literal notranslate"><span class="pre">cijoe</span></code> into <code class="docutils literal notranslate"><span class="pre">$PATH</span></code>.</p>
<p>Do a trial-run:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create a workdir</span>
mkdir<span class="w"> </span>-p<span class="w"> </span>~/workdirs/cijoe
<span class="nb">cd</span><span class="w"> </span>~/workdirs/cijoe

<span class="c1"># Create a default configuration and workflow</span>
cijoe<span class="w"> </span>--example<span class="w"> </span>core
</pre></div>
</div>
<p>In case everything is fine, then it will execute silently.</p>
<p>You can increase the information-level with <code class="docutils literal notranslate"><span class="pre">-l</span></code>
argument, the more times you provide the higher the level.
Try running it with two, that is debug-level:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>cijoe<span class="w"> </span>-ll
</pre></div>
</div>
<p>In the <code class="docutils literal notranslate"><span class="pre">cwd</span></code> then a <code class="docutils literal notranslate"><span class="pre">cijoe-output</span></code> is produced, this
directory holds all information about what was executed.
Have a look at the generated report at
<code class="docutils literal notranslate"><span class="pre">cijoe-output/report.html</span></code>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In case you see failures, then inspect the <code class="docutils literal notranslate"><span class="pre">RUNLOG</span></code> in the report, this
usually tells you exactly what went wrong.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Make sure that <code class="docutils literal notranslate"><span class="pre">pytest</span></code> is not installed system-wide by running <code class="docutils literal notranslate"><span class="pre">which</span>
<span class="pre">pytest</span></code>. In case it says <code class="docutils literal notranslate"><span class="pre">/usr/bin/pytest</span></code>, then it is not using the
<code class="docutils literal notranslate"><span class="pre">pytest</span></code> provided with the <strong>CIJOE</strong> module. Thus, uninstall it using
<code class="docutils literal notranslate"><span class="pre">apt-get</span> <span class="pre">remove</span> <span class="pre">python3-pytest</span></code>.</p>
</div>
</section>
<section id="linux-kernel">
<span id="sec-tutorials-devs-linux-customkernel"></span><h2>Linux Kernel<a class="headerlink" href="#linux-kernel" title="Permalink to this headline">¶</a></h2>
<p>Install prerequisites:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Essentials for building the kernel</span>
sudo<span class="w"> </span>apt-get<span class="w"> </span>-qy<span class="w"> </span>install<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>bc<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>bison<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>build-essential<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>debhelper<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>flex<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>git<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>libelf-dev<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>libssl-dev<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>pahole<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>rsync

<span class="c1"># A couple of extra libraries and tools</span>
sudo<span class="w"> </span>apt-get<span class="w"> </span>-qy<span class="w"> </span>install<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>libncurses-dev<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>linux-cpupower<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>python3-cpuinfo
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><code class="docutils literal notranslate"><span class="pre">libnurses-dev</span></code> is needed for <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">menuconfig</span></code>. <code class="docutils literal notranslate"><span class="pre">linux-cpupower</span></code>
provides a cli-tool <code class="docutils literal notranslate"><span class="pre">cpupower</span></code> that let’s you control the Linux CPU
governor, useful for performance evaluation.</p>
</div>
<p>Then run the <strong>cijoe</strong> workflow, compiling a custom kernel as a <code class="docutils literal notranslate"><span class="pre">.deb</span></code>
package:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Create a workdir for the workflow</span>
mkdir<span class="w"> </span>-p<span class="w"> </span>~/workdirs/linux
<span class="nb">cd</span><span class="w"> </span>~/workdirs/linux

<span class="c1"># Grab the cijoe-example for linux</span>
cijoe<span class="w"> </span>--example<span class="w"> </span>linux

<span class="c1"># Run it with logging (-l)</span>
cijoe<span class="w"> </span>-l
</pre></div>
</div>
<p>Then re-run the command above. It should now succeed, after which you can
collect the artifacts of interest:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>cp<span class="w"> </span>-r<span class="w"> </span>cijoe-output/artifacts/linux<span class="w"> </span>~/artifacts/
</pre></div>
</div>
<p>You can install them by running:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo<span class="w"> </span>dpkg<span class="w"> </span>-i<span class="w"> </span>~/artifacts/linux/*.deb
</pre></div>
</div>
</section>
<section id="qemu">
<span id="sec-tutorials-devs-linux-qemu"></span><h2>Qemu<a class="headerlink" href="#qemu" title="Permalink to this headline">¶</a></h2>
<p>Install prerequisites:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Packages for building qemu</span>
sudo<span class="w"> </span>apt-get<span class="w"> </span>-qy<span class="w"> </span>install<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>meson<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>libattr1-dev<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>libcap-ng-dev<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>libglib2.0-dev<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>libpixman-1-dev<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>libslirp-dev<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>pkg-config

<span class="c1"># Packages for cloud-init</span>
sudo<span class="w"> </span>apt-get<span class="w"> </span>-qy<span class="w"> </span>install<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>cloud-image-utils
</pre></div>
</div>
<p>Checkout qemu:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span><span class="w"> </span>~/git
git<span class="w"> </span>clone<span class="w"> </span>https://github.com/OpenMPDK/qemu<span class="w"> </span>--recursive
<span class="nb">cd</span><span class="w"> </span>qemu
git<span class="w"> </span>checkout<span class="w"> </span><span class="k">for</span>-xnvme
git<span class="w"> </span>submodule<span class="w"> </span>update<span class="w"> </span>--init<span class="w"> </span>--recursive
</pre></div>
</div>
<p>Create a work-directory:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>mkdir<span class="w"> </span>-p<span class="w"> </span>~/workdirs/qemu
<span class="nb">cd</span><span class="w"> </span>~/workdirs/qemu
</pre></div>
</div>
<p>Run the <strong>cijoe</strong> qemu workflow:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Grab the config and workflow example for qemu</span>
cijoe<span class="w"> </span>--example<span class="w"> </span>qemu

<span class="c1"># Run it with log-level debug (-l)</span>
cijoe<span class="w"> </span>-l
</pre></div>
</div>
<p>With the packages installed, go back and run the <strong>cijoe</strong> workflow. Have a
look at the report, it describes what it does, that is, build and install qemu,
spin up a vm using a cloud-init-enabled Debian image, ssh into it.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>In case you get errors such as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">Could</span> <span class="ow">not</span> <span class="n">access</span> <span class="n">KVM</span> <span class="n">kernel</span> <span class="n">module</span><span class="p">:</span> <span class="n">No</span> <span class="n">such</span> <span class="n">file</span> <span class="ow">or</span> <span class="n">directory</span>
<span class="n">qemu</span><span class="o">-</span><span class="n">system</span><span class="o">-</span><span class="n">x86_64</span><span class="p">:</span> <span class="n">failed</span> <span class="n">to</span> <span class="n">initialize</span> <span class="n">kvm</span><span class="p">:</span> <span class="n">No</span> <span class="n">such</span> <span class="n">file</span> <span class="ow">or</span> <span class="n">directory</span>
</pre></div>
</div>
<p>Then this is usually a symptom of virtualization being
disabled in the BIOS of the physical machine. Have a look
at <code class="docutils literal notranslate"><span class="pre">dmesg</span></code> it might proide messages supporting this.</p>
</div>
</section>
<section id="xnvme">
<h2>xNVMe<a class="headerlink" href="#xnvme" title="Permalink to this headline">¶</a></h2>
<section id="clone-build-and-install">
<h3>clone, build, and install<a class="headerlink" href="#clone-build-and-install" title="Permalink to this headline">¶</a></h3>
<p>Clone <strong>xNVMe</strong> and checkout the <code class="docutils literal notranslate"><span class="pre">next</span></code> branch:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span><span class="w"> </span>~/git
git<span class="w"> </span>clone<span class="w"> </span>https://github.com/OpenMPDK/xNVMe.git<span class="w"> </span>xnvme
<span class="nb">cd</span><span class="w"> </span>xnvme
git<span class="w"> </span>checkout<span class="w"> </span>next
</pre></div>
</div>
<p>Install prerequisites:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo<span class="w"> </span>./toolbox/pkgs/debian-bookworm.sh
</pre></div>
</div>
<p>Build and install <strong>xNVMe</strong>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span><span class="w"> </span>~/git/xnvme
make
sudo<span class="w"> </span>make<span class="w"> </span>install
</pre></div>
</div>
<p>Check that it is functional:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>sudo<span class="w"> </span>xnvme<span class="w"> </span>enum
</pre></div>
</div>
<p>This should yield output similar to:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>xnvme_cli_enumeration:
-<span class="w"> </span><span class="o">{</span>uri:<span class="w"> </span><span class="s1">&#39;/dev/nvme0n1&#39;</span>,<span class="w"> </span>dtype:<span class="w"> </span>0x2,<span class="w"> </span>nsid:<span class="w"> </span>0x1,<span class="w"> </span>csi:<span class="w"> </span>0x0,<span class="w"> </span>subnqn:<span class="w"> </span><span class="s1">&#39;&#39;</span><span class="o">}</span>
</pre></div>
</div>
</section>
<section id="artifacts">
<h3>Artifacts<a class="headerlink" href="#artifacts" title="Permalink to this headline">¶</a></h3>
<p>Produce a set of <strong>artifacts</strong>:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="nb">cd</span><span class="w"> </span>~/git/xnvme
make<span class="w"> </span>clobber<span class="w"> </span>gen-artifacts

<span class="c1"># Keep them handy if need be</span>
cp<span class="w"> </span>-r<span class="w"> </span>/tmp/artifacts<span class="w"> </span>~/artifacts/xnvme
</pre></div>
</div>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>The <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">clobber</span></code> removes any unstaged changes and removes subprojects.
This is done to ensure an entirely “clean” repository. Thus, make sure that
you have commit your changes.
The <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">clobber</span></code> is required for <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">gen-artifacts</span></code>, as it will
otherwise include side-effects from previous builds.</p>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The artifacts produces by <code class="docutils literal notranslate"><span class="pre">make</span> <span class="pre">gen-artifacts</span></code> are output to
<code class="docutils literal notranslate"><span class="pre">/tmp/artifacts</span></code>. There are <strong>cijoe</strong> workflows, expecting to be available
at that location, specifically the <strong>provision</strong> workflow.</p>
</div>
</section>
</section>
<section id="reproduce-github-actions-locally">
<h2>Reproduce GitHUB Actions locally<a class="headerlink" href="#reproduce-github-actions-locally" title="Permalink to this headline">¶</a></h2>
<p>The <strong>cijoe</strong> workflows and configurations in this directory are used in the
xNVMe GitHUB actions. You can reproduce what is running on GitHUB by adjusting
the config-files, and provide the artifacts from the GitHUB action:</p>
<ul class="simple">
<li><p>xnvme-py-sdist.tar.gz</p></li>
<li><p>xnvme-src.tar.gz</p></li>
</ul>
<p>To do so, then:</p>
<ul class="simple">
<li><p>Place the artifacts in <code class="docutils literal notranslate"><span class="pre">/tmp/artifacts</span></code></p></li>
<li><p>Change <code class="docutils literal notranslate"><span class="pre">qemu.system_bin</span></code> to point to your qemu-system-binary (qemu 7+)</p></li>
<li><p>Add the SSH-key(<code class="docutils literal notranslate"><span class="pre">keys/guest_key</span></code>) to your SSH-agent.</p></li>
</ul>
<p>Then you should be able to run the following:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span><span class="c1"># Provision and test on Debian Bullseye</span>
cijoe<span class="w"> </span>-c<span class="w"> </span>configs/debian-bullseye.toml<span class="w"> </span>-w<span class="w"> </span>workflows/provision.yaml
cijoe<span class="w"> </span>-c<span class="w"> </span>configs/debian-bullseye.toml<span class="w"> </span>-w<span class="w"> </span>workflows/test-debian-bullseye.yaml

<span class="c1"># Provision and test on FreeBSD 13</span>
cijoe<span class="w"> </span>-c<span class="w"> </span>configs/freebsd-13.toml<span class="w"> </span>-w<span class="w"> </span>workflows/provision.yaml
cijoe<span class="w"> </span>-c<span class="w"> </span>configs/freebsd-13.toml<span class="w"> </span>-w<span class="w"> </span>workflows/test-freebsd-13.yaml

<span class="c1"># Generate documentation (provisions qemu-guest and generates the docs)</span>
cijoe<span class="w"> </span>-c<span class="w"> </span>configs/debian-bullseye.toml<span class="w"> </span>-w<span class="w"> </span>workflows/docgen.yaml
</pre></div>
</div>
<p>In case you are setting up the test-target using other tools, or just want to
run pytest directly, then the following two sections describe how to do that.</p>
</section>
<section id="running-pytest-from-the-repository">
<h2>Running pytest from the repository<a class="headerlink" href="#running-pytest-from-the-repository" title="Permalink to this headline">¶</a></h2>
<p>Invoke pytest providing a configuration file and an output directory for
artifacts and captured output:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>pytest<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--config<span class="w"> </span>configs/debian-bullseye.toml<span class="w"> </span><span class="se">\</span>
<span class="w">  </span>--output<span class="w"> </span>/tmp/somewhere<span class="w"> </span><span class="se">\</span>
<span class="w"> </span>tests
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">--config</span></code> is needed to inform pytest about the environment you are
running in such as which devices it can use for testing. The information is
utilized by pytest to, among other things, do parametrization for xNVMe backend
configurations etc.</p>
<section id="provision-a-qemu-guest">
<h3>Provision a qemu-guest<a class="headerlink" href="#provision-a-qemu-guest" title="Permalink to this headline">¶</a></h3>
<p>Setup a virtual machine with <strong>xNVMe</strong> installed, and a bunch of NVMe devices configured:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>cijoe<span class="w"> </span>-c<span class="w"> </span>configs/debian-bullseye.toml<span class="w"> </span>-w<span class="w"> </span>provision.yaml
</pre></div>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>It will likely fail with the error:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">sh</span><span class="p">:</span> <span class="mi">1</span><span class="p">:</span> <span class="o">/</span><span class="n">opt</span><span class="o">/</span><span class="n">qemu</span><span class="o">/</span><span class="nb">bin</span><span class="o">/</span><span class="n">qemu</span><span class="o">-</span><span class="n">system</span><span class="o">-</span><span class="n">x86_64</span><span class="p">:</span> <span class="ow">not</span> <span class="n">found</span>
</pre></div>
</div>
<p>This is because the default configuration is for running on Github. Thus,
adjust the file <code class="docutils literal notranslate"><span class="pre">configs/debian-bullseye.toml</span></code> such that qemu is
pointing to <code class="docutils literal notranslate"><span class="pre">$HOME</span></code>.</p>
</div>
</section>
<section id="create-boot-images">
<h3>Create boot-images<a class="headerlink" href="#create-boot-images" title="Permalink to this headline">¶</a></h3>
<p>The <code class="docutils literal notranslate"><span class="pre">debian-bullseye-amd64.qcow2</span></code> is created by:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>cijoe<span class="w"> </span>-c<span class="w"> </span>configs/debian-bullseye.toml<span class="w"> </span>-w<span class="w"> </span>workflows/bootimg-debian-bullseye-amd64.yaml
</pre></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">freebsd-13.1-ksrc-amd64.qcow2</span></code> is created by:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>cijoe<span class="w"> </span>-c<span class="w"> </span>configs/freebsd-13.toml<span class="w"> </span>-w<span class="w"> </span>workflows/bootimg-freebsd-13-amd64.yaml
</pre></div>
</div>
</section>
</section>
<section id="remote-dev">
<h2>Remote dev<a class="headerlink" href="#remote-dev" title="Permalink to this headline">¶</a></h2>
<p>Assuming your primary device for development is something like a
Chromebook/Macbook, something light-weight and great for reading mail… but
now you want to fire up your editor and do some development.</p>
<p>Or, your primary system is simply separate from the dev-box for a myriad of
reasons. Then do something like:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>cp<span class="w"> </span>configs/debian-bullseye.toml<span class="w"> </span>configs/dev-metal.toml
</pre></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>all configs prefix on the file-name pattern <code class="docutils literal notranslate"><span class="pre">dev-*.toml</span></code> are ignored by git.</p>
</div>
<p>Open up <code class="docutils literal notranslate"><span class="pre">configs/dev-metal.toml</span></code> and adjust it to your physical machine. That
is, change the ssh-login information, change the list of devices, paths to
binaries etc. Once you have done that, then go ahead and run:</p>
<div class="highlight-bash notranslate"><div class="highlight"><pre><span></span>cijoe<span class="w"> </span>-c<span class="w"> </span>configs/dev-metal.toml<span class="w"> </span>-w<span class="w"> </span>dev-sync-and-build.yaml
</pre></div>
</div>
</section>
</section>


           </div>
          </div>
          <footer><div class="rst-footer-buttons" role="navigation" aria-label="Footer">
        <a href="../fdp/index.html" class="btn btn-neutral float-left" title="Flexible Data Placement" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
        <a href="../dynamic_loading/index.html" class="btn btn-neutral float-right" title="Dynamically loading xNVMe" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright 2023, xNVMe.</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>
    <!-- Theme Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=UA-159785887-1"></script>
    <script>
      window.dataLayer = window.dataLayer || [];
      function gtag(){dataLayer.push(arguments);}
      gtag('js', new Date());

      gtag('config', 'UA-159785887-1', {
          'anonymize_ip': false,
      });
    </script> 

</body>
</html>